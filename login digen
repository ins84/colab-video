# ============================================
# CELLA 3: LOGIN E SALVA COOKIES (CORRETTA)
# ============================================

import getpass
from playwright.async_api import async_playwright
import asyncio
import json
from pathlib import Path

print("üîê CONFIGURAZIONE LOGIN DIGEN.AI")
print("="*60)
print("Inserisci le credenziali del tuo account Digen.ai")
print("(Se non hai account, creane uno su https://digen.ai)")
print("="*60)
print()

EMAIL = input("üìß Email: ")
PASSWORD = getpass.getpass("üîí Password: ")

print("\n‚úÖ Credenziali salvate!")
print("\nüîÑ Eseguo login e salvo sessione...")

async def save_login():
    cookies_file = Path("digen_cookies.json")
    debug_folder = Path("debug_screenshots")
    debug_folder.mkdir(exist_ok=True)

    async with async_playwright() as p:
        browser = await p.chromium.launch(
            headless=True,
            args=['--no-sandbox', '--disable-dev-shm-usage']
        )
        context = await browser.new_context(
            viewport={'width': 1920, 'height': 1080},
            user_agent='Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        )
        page = await context.new_page()

        try:
            print("üåê Apertura pagina login...")
            await page.goto("https://digen.ai/signin", timeout=30000)
            await asyncio.sleep(5)

            # Screenshot iniziale
            await page.screenshot(path=debug_folder / "1_login_page.png", full_page=True)
            print("üì∏ Screenshot pagina: debug_screenshots/1_login_page.png")

            # ‚úÖ NUOVO: Usa selettori pi√π flessibili per trovare i campi
            print("üîç Cerco campo email...")

            # Prova tutti questi selettori
            email_selectors = [
                'input[placeholder*="email" i]',
                'input[placeholder*="Email" i]',
                'input[placeholder*="tua email" i]',
                'input[type="email"]',
                'input[name="email"]',
                '#email',
                'input[aria-label*="email" i]',
                'input:not([type="password"])',  # Primo input che non √® password
            ]

            email_field = None
            for selector in email_selectors:
                try:
                    count = await page.locator(selector).count()
                    if count > 0:
                        email_field = page.locator(selector).first
                        print(f"‚úÖ Campo email trovato con: {selector}")
                        break
                except:
                    continue

            if not email_field:
                # Fallback: prendi il primo input visibile
                try:
                    all_inputs = await page.locator('input:visible').all()
                    if len(all_inputs) >= 2:
                        email_field = all_inputs[0]
                        print(f"‚úÖ Campo email trovato (primo input visibile)")
                except:
                    pass

            if not email_field:
                print("‚ùå Campo email non trovato!")
                print("üìã Prova questi metodi alternativi:")
                print("   1. Usa 'Continua con Google' invece")
                print("   2. Esporta cookies manualmente da browser")
                return False

            print(f"üìß Inserisco email: {EMAIL}")
            await email_field.click()
            await asyncio.sleep(0.5)
            await email_field.fill(EMAIL)
            await asyncio.sleep(1)

            # Screenshot dopo email
            await page.screenshot(path=debug_folder / "2_email_filled.png", full_page=True)

            print("üîç Cerco campo password...")

            # Prova tutti questi selettori per password
            password_selectors = [
                'input[type="password"]',
                'input[placeholder*="password" i]',
                'input[placeholder*="Password" i]',
                'input[name="password"]',
                '#password',
                'input[aria-label*="password" i]',
            ]

            password_field = None
            for selector in password_selectors:
                try:
                    count = await page.locator(selector).count()
                    if count > 0:
                        password_field = page.locator(selector).first
                        print(f"‚úÖ Campo password trovato con: {selector}")
                        break
                except:
                    continue

            if not password_field:
                # Fallback: prendi il secondo input visibile
                try:
                    all_inputs = await page.locator('input:visible').all()
                    if len(all_inputs) >= 2:
                        password_field = all_inputs[1]
                        print(f"‚úÖ Campo password trovato (secondo input visibile)")
                except:
                    pass

            if not password_field:
                print("‚ùå Campo password non trovato!")
                return False

            print("üîí Inserisco password...")
            await password_field.click()
            await asyncio.sleep(0.5)
            await password_field.fill(PASSWORD)
            await asyncio.sleep(1)

            # Screenshot form completo
            await page.screenshot(path=debug_folder / "3_form_filled.png", full_page=True)
            print("üì∏ Screenshot form compilato")

            print("üîç Cerco bottone submit...")

            # Prova tutti questi selettori per il bottone
            submit_selectors = [
                'button:has-text("Accedi")',
                'button:has-text("accedi")',
                'button:has-text("ACCEDI")',
                'button:has-text("Sign in")',
                'button:has-text("Login")',
                'button:has-text("Log in")',
                'button[type="submit"]',
                'input[type="submit"]',
                'button:visible:not(:has-text("Google"))',  # Bottone che non dice "Google"
            ]

            submit_btn = None
            for selector in submit_selectors:
                try:
                    count = await page.locator(selector).count()
                    if count > 0:
                        submit_btn = page.locator(selector).first
                        print(f"‚úÖ Bottone trovato con: {selector}")
                        break
                except:
                    continue

            if not submit_btn:
                # Fallback: cerca qualsiasi bottone blu visibile
                try:
                    all_buttons = await page.locator('button:visible').all()
                    for btn in all_buttons:
                        text = await btn.inner_text()
                        if text and "google" not in text.lower():
                            submit_btn = btn
                            print(f"‚úÖ Bottone trovato: {text}")
                            break
                except:
                    pass

            if not submit_btn:
                print("‚ùå Bottone submit non trovato!")
                return False

            print("üñ±Ô∏è Clicco submit...")
            await submit_btn.click()

            print("‚è≥ Attendo risposta (8 secondi)...")
            await asyncio.sleep(8)

            # Screenshot dopo submit
            await page.screenshot(path=debug_folder / "4_after_submit.png", full_page=True)
            print("üì∏ Screenshot dopo submit")

            # Verifica URL
            current_url = page.url
            print(f"üìç URL attuale: {current_url}")

            # Controlla se siamo ancora sulla pagina di login
            if "signin" in current_url or "login" in current_url:
                print("\n‚ö†Ô∏è Ancora sulla pagina login!")

                # Controlla se ci sono messaggi di errore
                try:
                    error_text = await page.locator('text=/error|errore|incorrect|sbagliato/i').first.text_content(timeout=2000)
                    print(f"   Errore visibile: {error_text}")
                except:
                    pass

                print("\n‚ùå Login fallito!")
                print("   Possibili cause:")
                print("   ‚Ä¢ Credenziali errate")
                print("   ‚Ä¢ Captcha/Verifica richiesta")
                print("   ‚Ä¢ Rate limit")
                print("\nüì∏ Controlla gli screenshot in debug_screenshots/")
                return False

            # Login riuscito! Salva cookies
            cookies = await context.cookies()

            if len(cookies) < 1:
                print("‚ö†Ô∏è Nessun cookie ricevuto (strano...)")
                # Ma proviamo comunque a salvare

            with open(cookies_file, 'w') as f:
                json.dump(cookies, f, indent=2)

            print(f"\n‚úÖ LOGIN RIUSCITO!")
            print(f"üíæ Salvati {len(cookies)} cookies")
            print(f"üìù File: digen_cookies.json")

            # Mostra alcuni cookies (senza valori sensibili)
            print(f"\nüç™ Cookies salvati:")
            for cookie in cookies[:5]:
                print(f"   ‚Ä¢ {cookie['name']} (domain: {cookie['domain']})")
            if len(cookies) > 5:
                print(f"   ... e altri {len(cookies)-5}")

            return True

        except Exception as e:
            print(f"\n‚ùå ERRORE: {e}")
            try:
                await page.screenshot(path=debug_folder / "error.png", full_page=True)
                print("üì∏ Screenshot errore salvato")
            except:
                pass
            return False

        finally:
            await browser.close()

# Esegui login
success = await save_login()

if success:
    print("\n" + "="*60)
    print("üéâ SETUP COMPLETATO!")
    print("="*60)
    print("\nüí° Ora esegui la CELLA 4 per generare i video!")
    print("   I cookies verranno riutilizzati automaticamente")
else:
    print("\n" + "="*60)
    print("‚ùå SETUP FALLITO")
    print("="*60)
    print("\nüìã METODI ALTERNATIVI:")
    print("\n1Ô∏è‚É£ LOGIN CON GOOGLE (pi√π facile):")
    print("   ‚Ä¢ Vai su https://digen.ai")
    print("   ‚Ä¢ Clicca 'Continua con Google'")
    print("   ‚Ä¢ Esporta cookies con extension browser")
    print("\n2Ô∏è‚É£ ESPORTA COOKIES MANUALMENTE:")
    print("   ‚Ä¢ Installa 'EditThisCookie' (Chrome extension)")
    print("   ‚Ä¢ Fai login manualmente su digen.ai")
    print("   ‚Ä¢ Esporta cookies")
    print("   ‚Ä¢ Carica su Colab come digen_cookies.json")
    print("\n3Ô∏è‚É£ PROVA DI NUOVO:")
    print("   ‚Ä¢ Verifica email/password corrette")
    print("   ‚Ä¢ Riesegui questa cella")
